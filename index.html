<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Padel Koty</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg:         #0f172a;
  --surface:    rgba(30,41,59,0.85);
  --surface2:   rgba(30,41,59,0.5);
  --border:     rgba(255,255,255,0.1);
  --text:       #f8fafc;
  --muted:      #64748b;
  --accent:     #bef264;
  --accent-dim: rgba(190,242,100,.12);
  --red:        #ef4444;
  --red-dim:    rgba(239,68,68,.12);
  --gold:       #fbbf24;
  --silver:     #9ca3af;
  --bronze:     #cd7f32;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; padding-bottom: 60px;
}

/* ‚îÄ‚îÄ Screens ‚îÄ‚îÄ */
.screen { display:none; max-width:580px; margin:0 auto; padding:28px 16px; }
.screen.active { display:block; animation:fadeUp .22s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
.login-wrap {
  min-height:100vh; display:flex; flex-direction:column;
  align-items:center; justify-content:center; padding:40px 24px;
  max-width:380px; margin:0 auto;
}
.login-logo { font-size:4rem; margin-bottom:16px; }
.login-title { font-size:2rem; font-weight:900; color:var(--accent); margin-bottom:6px; }
.login-sub { font-size:.9rem; color:var(--muted); margin-bottom:40px; text-align:center; }
.btn-google {
  display:flex; align-items:center; justify-content:center; gap:12px;
  width:100%; padding:14px 24px; border:1.5px solid var(--border);
  border-radius:12px; background:rgba(255,255,255,0.06); color:var(--text);
  font-size:1rem; font-weight:700; cursor:pointer;
  transition:background .2s, border-color .2s, transform .15s;
  font-family:inherit;
}
.btn-google:hover { background:rgba(255,255,255,0.1); border-color:var(--accent); transform:translateY(-1px); }
.btn-google svg { flex-shrink:0; }

/* ‚îÄ‚îÄ User bar ‚îÄ‚îÄ */
.user-bar {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:24px; gap:10px;
}
.user-info { display:flex; align-items:center; gap:10px; }
.user-photo {
  width:32px; height:32px; border-radius:50%;
  object-fit:cover; border:2px solid var(--accent);
}
.user-name { font-size:.875rem; font-weight:700; }
.btn-logout {
  background:transparent; border:1.5px solid var(--border);
  color:var(--muted); font-size:.75rem; font-weight:700;
  padding:6px 12px; border-radius:8px; cursor:pointer;
  font-family:inherit; transition:color .15s, border-color .15s;
}
.btn-logout:hover { color:var(--red); border-color:var(--red); }

/* ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ */
.topbar { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
.back-btn {
  background:var(--surface); backdrop-filter:blur(12px);
  border:1px solid var(--border); color:var(--text);
  padding:8px 14px; border-radius:8px; font-size:.875rem;
  font-weight:600; cursor:pointer; flex-shrink:0; font-family:inherit;
}
.back-btn:hover { border-color:var(--accent); }
.topbar-title { font-size:1.1rem; font-weight:700; flex:1; }

/* ‚îÄ‚îÄ App title ‚îÄ‚îÄ */
.app-title {
  text-align:center; font-size:2.2rem; font-weight:900;
  color:var(--accent); letter-spacing:-.03em; margin-bottom:4px;
}
.app-sub { text-align:center; color:var(--muted); font-size:.875rem; margin-bottom:28px; }

/* ‚îÄ‚îÄ Section header ‚îÄ‚îÄ */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.section-title { font-size:.72rem; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:var(--muted); }

/* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
.btn {
  display:block; width:100%; padding:14px 20px; border:none; border-radius:10px;
  font-size:.875rem; font-weight:700; cursor:pointer; text-align:center;
  text-transform:uppercase; letter-spacing:.06em; font-family:inherit;
  transition:transform .2s ease, box-shadow .2s ease;
}
.btn:active { transform:scale(.97); }
.btn-primary {
  background:linear-gradient(135deg,#0284c7,#bef264);
  color:#000; box-shadow:0 4px 14px rgba(190,242,100,.2);
}
.btn-primary:hover { transform:translateY(-2px); box-shadow:0 0 20px rgba(190,242,100,.4); }
.btn-outline {
  background:transparent; color:var(--text); border:1.5px solid var(--border);
}
.btn-outline:hover { border-color:var(--accent); transform:translateY(-1px); }
.btn-danger { background:var(--red); color:#fff; }
.btn-sm { display:inline-block; width:auto; padding:8px 16px; font-size:.78rem; border-radius:8px; }
.mt8 { margin-top:8px; }
.mt12 { margin-top:12px; }
.mt16 { margin-top:16px; }

/* ‚îÄ‚îÄ Home actions ‚îÄ‚îÄ */
.home-actions { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
.card {
  background:var(--surface); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom:10px;
  cursor:pointer; transition:border-color .15s, box-shadow .15s;
  box-shadow:0 10px 15px -3px rgba(0,0,0,.4);
}
.card:hover { border-color:var(--accent); box-shadow:0 0 18px rgba(190,242,100,.15); }
.card-row { display:flex; align-items:center; justify-content:space-between; }
.card-title { font-size:1rem; font-weight:700; margin-bottom:4px; }
.card-meta { font-size:.8rem; color:var(--muted); }

/* ‚îÄ‚îÄ Badge ‚îÄ‚îÄ */
.badge { display:inline-block; font-size:.65rem; font-weight:700; padding:3px 9px; border-radius:99px; text-transform:uppercase; letter-spacing:.08em; }
.badge-green { background:var(--accent-dim); color:var(--accent); }
.badge-muted { background:rgba(255,255,255,.06); color:var(--muted); }
.badge-red   { background:var(--red-dim); color:var(--red); }

/* ‚îÄ‚îÄ Inputs ‚îÄ‚îÄ */
.form-group { margin-bottom:16px; }
.form-label { display:block; font-size:.68rem; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:var(--muted); margin-bottom:6px; }
.txt-inp, .sel-inp {
  width:100%; background:var(--surface); backdrop-filter:blur(12px);
  border:1px solid var(--border); color:var(--text);
  padding:11px 13px; border-radius:9px; font-size:.95rem; font-family:inherit;
  transition:border-color .15s, box-shadow .15s;
}
.txt-inp::placeholder { color:var(--muted); }
.txt-inp:focus, .sel-inp:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-dim); }
.sel-inp option { background:#1e293b; }

/* ‚îÄ‚îÄ Players ‚îÄ‚îÄ */
.player-item {
  display:flex; align-items:center; gap:12px;
  background:var(--surface); backdrop-filter:blur(12px);
  border:1px solid var(--border); border-radius:10px;
  padding:10px 14px; margin-bottom:8px;
}
.avatar {
  width:36px; height:36px; border-radius:50%; flex-shrink:0;
  background:var(--accent-dim); color:var(--accent);
  display:flex; align-items:center; justify-content:center;
  font-size:.78rem; font-weight:800;
}
.player-name { flex:1; font-size:.95rem; font-weight:600; }
.icon-btn { background:none; border:none; cursor:pointer; color:var(--muted); font-size:1rem; padding:4px 8px; border-radius:6px; }
.icon-btn:hover { color:var(--red); background:var(--red-dim); }

/* ‚îÄ‚îÄ Player select ‚îÄ‚îÄ */
.player-check-item {
  display:flex; align-items:center; gap:12px;
  background:var(--surface); backdrop-filter:blur(12px);
  border:1px solid var(--border); border-radius:10px;
  padding:10px 14px; margin-bottom:8px; cursor:pointer;
  transition:border-color .15s, background .15s;
}
.player-check-item.selected { border-color:var(--accent); background:var(--accent-dim); }
.check-icon { font-size:1.1rem; flex-shrink:0; }

/* ‚îÄ‚îÄ Court card ‚îÄ‚îÄ */
.court-card {
  background:var(--surface); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--border); border-radius:16px; padding:18px; margin-bottom:14px;
  box-shadow:0 10px 15px -3px rgba(0,0,0,.4);
}
.court-badge {
  display:inline-block; font-size:.65rem; font-weight:700;
  color:var(--accent); text-transform:uppercase; letter-spacing:.12em;
  background:var(--accent-dim); padding:3px 9px; border-radius:99px; margin-bottom:12px;
}
.teams-row { display:flex; align-items:center; gap:8px; margin-bottom:14px; }
.team-lbl { flex:1; font-size:.88rem; font-weight:600; line-height:1.4; }
.team-lbl.right { text-align:right; }
.vs-pill { font-size:.65rem; font-weight:700; color:var(--muted); border:1px solid var(--border); padding:2px 6px; border-radius:4px; flex-shrink:0; }
.score-row { display:flex; align-items:flex-end; gap:8px; }
.score-box { flex:1; display:flex; flex-direction:column; gap:4px; }
.score-cap { font-size:.65rem; color:var(--muted); text-align:center; }
.score-inp {
  width:100%; background:rgba(0,0,0,.3); border:1px solid var(--border); color:var(--text);
  padding:12px 6px; border-radius:8px; font-size:1.5rem; font-weight:700;
  text-align:center; -moz-appearance:textfield; font-family:inherit;
  transition:border-color .15s, box-shadow .15s;
}
.score-inp::-webkit-outer-spin-button,.score-inp::-webkit-inner-spin-button { -webkit-appearance:none; }
.score-inp:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-dim); }
.score-inp:disabled { color:var(--muted); border-color:rgba(255,255,255,.05); background:rgba(255,255,255,.02); cursor:default; }
.score-sep { font-size:1.5rem; font-weight:700; color:var(--muted); padding-bottom:10px; flex-shrink:0; }

/* ‚îÄ‚îÄ Resting ‚îÄ‚îÄ */
.resting-bar { background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:10px; padding:10px 14px; margin-bottom:14px; font-size:.82rem; color:var(--muted); }
.resting-bar strong { color:var(--text); }

/* ‚îÄ‚îÄ Round header ‚îÄ‚îÄ */
.round-header { text-align:center; margin-bottom:22px; }
.round-lbl { font-size:.72rem; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:var(--muted); }
.round-num { font-size:1.5rem; font-weight:800; margin:2px 0 10px; }
.progress-track { width:100%; height:5px; background:rgba(255,255,255,.08); border-radius:99px; overflow:hidden; }
.progress-bar { height:100%; background:linear-gradient(90deg,#0284c7,#bef264); border-radius:99px; transition:width .4s ease; }

/* ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ */
.lb {
  background:var(--surface); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
  border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:20px;
  box-shadow:0 10px 15px -3px rgba(0,0,0,.4);
}
.lb-title { padding:12px 16px; background:var(--surface2); border-bottom:1px solid var(--border); font-size:.85rem; font-weight:700; }
.lb-head {
  display:grid; grid-template-columns:42px 1fr 36px 36px 50px 50px 56px;
  padding:8px 14px; background:var(--surface2); border-bottom:1px solid var(--border);
}
.lb-head span { font-size:.62rem; font-weight:700; text-transform:uppercase; letter-spacing:.07em; color:var(--muted); text-align:center; }
.lb-head span:nth-child(2) { text-align:left; }
.lb-row {
  display:grid; grid-template-columns:42px 1fr 36px 36px 50px 50px 56px;
  align-items:center; padding:11px 14px; border-bottom:1px solid var(--border);
}
.lb-row:last-child { border-bottom:none; }
.lb-row.r1 { background:rgba(251,191,36,.07); }
.lb-row.r2 { background:rgba(156,163,175,.05); }
.lb-row.r3 { background:rgba(205,127,50,.05); }
.lb-rank { font-size:.9rem; font-weight:700; color:var(--muted); text-align:center; }
.lb-row.r1 .lb-rank { color:var(--gold); }
.lb-row.r2 .lb-rank { color:var(--silver); }
.lb-row.r3 .lb-rank { color:var(--bronze); }
.lb-name { font-size:.9rem; font-weight:600; }
.lb-cell { font-size:.88rem; font-weight:600; text-align:center; color:var(--muted); }
.lb-pm { font-size:.9rem; font-weight:700; text-align:right; padding-right:4px; }
.lb-pm.pos { color:var(--accent); }
.lb-pm.neg { color:var(--red); }
.lb-pm.zer { color:var(--muted); }

/* ‚îÄ‚îÄ Misc ‚îÄ‚îÄ */
.inline-err { background:#450a0a; color:#fca5a5; border:1px solid #7f1d1d; border-radius:8px; padding:10px 14px; font-size:.875rem; font-weight:600; margin-bottom:12px; }
.empty { text-align:center; padding:40px 20px; color:var(--muted); font-size:.9rem; }
.empty-icon { font-size:2.5rem; margin-bottom:10px; }
.month-badge { display:inline-block; font-size:.72rem; font-weight:700; padding:3px 10px; border-radius:99px; background:rgba(255,255,255,.06); color:var(--muted); margin-bottom:10px; margin-top:6px; }
.divider { height:1px; background:var(--border); margin:20px 0; }
.trophy-header { text-align:center; margin-bottom:20px; }
.trophy-icon { font-size:3rem; }
.trophy-title { font-size:1.6rem; font-weight:800; color:var(--accent); margin:6px 0 4px; }
.trophy-sub { font-size:.875rem; color:var(--muted); }
.standings-wrap { margin-top:16px; }
.loading { text-align:center; padding:60px 20px; color:var(--muted); }

@media (max-width:400px) {
  .lb-head,.lb-row { grid-template-columns:34px 1fr 28px 28px 40px 40px 46px; }
  .home-actions { grid-template-columns:1fr; }
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div id="sLogin" class="screen active" style="padding:0; max-width:100%;">
  <div class="login-wrap">
    <div class="login-logo">üê±</div>
    <div class="login-title">Padel Koty</div>
    <div class="login-sub">Americano ¬∑ ZarzƒÖdzanie turniejami</div>
    <button class="btn-google" id="googleSignInBtn">
      <svg width="20" height="20" viewBox="0 0 48 48">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.35-8.16 2.35-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
      </svg>
      Zaloguj siƒô przez Google
    </button>
    <div id="loginErr" style="color:var(--red);font-size:.85rem;margin-top:12px;text-align:center;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
<div id="sHome" class="screen">
  <div class="user-bar">
    <div class="user-info">
      <img class="user-photo" id="userPhoto" src="" alt="">
      <span class="user-name" id="userName"></span>
    </div>
    <button class="btn-logout" id="logoutBtn">Wyloguj</button>
  </div>
  <h1 class="app-title">Padel Koty</h1>
  <p class="app-sub">Americano ¬∑ ZarzƒÖdzanie turniejami</p>
  <div class="section-header">
    <span class="section-title">Aktywne turnieje</span>
    <button class="btn btn-primary btn-sm" id="newTournamentBtn">+ Nowy turniej</button>
  </div>
  <div id="homeTournaments"><div class="loading">≈Åadowanie‚Ä¶</div></div>
  <div class="divider"></div>
  <div class="home-actions">
    <button class="btn btn-outline" id="homePlayersBtn">üë• Gracze</button>
    <button class="btn btn-outline" id="homeLeaderboardBtn">üèÜ Leaderboard</button>
  </div>
</div>

<!-- ‚ïê‚ïê PLAYERS ‚ïê‚ïê -->
<div id="sPlayers" class="screen">
  <div class="topbar">
    <button class="back-btn" id="playersBackBtn">‚Üê Wr√≥ƒá</button>
    <span class="topbar-title">Baza graczy</span>
  </div>
  <div style="display:flex; gap:8px; margin-bottom:16px;">
    <input class="txt-inp" id="newPlayerInp" placeholder="Imiƒô gracza‚Ä¶">
    <button class="btn btn-primary btn-sm" style="flex-shrink:0;" id="addPlayerBtn">Dodaj</button>
  </div>
  <div id="playersList"></div>
</div>

<!-- ‚ïê‚ïê CREATE TOURNAMENT ‚ïê‚ïê -->
<div id="sCreate" class="screen">
  <div class="topbar">
    <button class="back-btn" id="createBackBtn">‚Üê Wr√≥ƒá</button>
    <span class="topbar-title">Nowy turniej</span>
  </div>
  <div class="form-group">
    <label class="form-label">Nazwa turnieju</label>
    <input class="txt-inp" id="tName" placeholder="np. Grudniowe Koty">
  </div>
  <div class="form-group">
    <label class="form-label">MiesiƒÖc</label>
    <select class="sel-inp" id="tMonth"></select>
  </div>
  <div class="form-group">
    <label class="form-label">Liczba rund</label>
    <select class="sel-inp" id="tRounds">
      <option value="5">5 rund</option>
      <option value="7">7 rund</option>
      <option value="9">9 rund</option>
      <option value="11" selected>11 rund</option>
      <option value="13">13 rund</option>
      <option value="15">15 rund</option>
    </select>
  </div>
  <div class="section-header">
    <span class="section-title">Wybierz graczy (min. 4)</span>
    <span id="selectedCount" style="font-size:.8rem;color:var(--muted);">0 wybranych</span>
  </div>
  <div id="createPlayerList" style="margin-bottom:20px;"></div>
  <div id="createErr"></div>
  <button class="btn btn-primary" id="startTournamentBtn">Losuj pary ‚Üí</button>
</div>

<!-- ‚ïê‚ïê PLAY ‚ïê‚ïê -->
<div id="sPlay" class="screen">
  <div class="topbar">
    <button class="back-btn" id="playBackBtn">‚Üê Wr√≥ƒá</button>
    <span class="topbar-title" id="playTitle">Turniej</span>
  </div>
  <div class="round-header">
    <div class="round-lbl">Runda</div>
    <div class="round-num" id="roundNum">1 / 11</div>
    <div class="progress-track"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
  </div>
  <div id="restingBar"></div>
  <div id="courtsArea"></div>
  <div id="playErr"></div>
  <button class="btn btn-primary" id="nextRoundBtn">Nastƒôpna runda ‚Üí</button>
  <button class="btn btn-outline mt8" id="standingsBtn">üìä Aktualna tabela</button>
  <div id="standingsWrap" class="standings-wrap" style="display:none;"></div>
  <button class="btn btn-outline mt8" id="finishEarlyBtn">üèÅ Zako≈Ñcz turniej</button>
</div>

<!-- ‚ïê‚ïê RESULTS ‚ïê‚ïê -->
<div id="sResults" class="screen">
  <div class="topbar">
    <button class="back-btn" id="resultsBackBtn">‚Üê Turnieje</button>
    <span class="topbar-title" id="resultsTitle">Wyniki</span>
  </div>
  <div class="trophy-header">
    <div class="trophy-icon">üèÜ</div>
    <div class="trophy-title">Turniej zako≈Ñczony!</div>
    <div class="trophy-sub" id="resultsSub"></div>
  </div>
  <div id="resultsLb"></div>
  <button class="btn btn-outline" id="resultsHomeBtn">‚Üê Powr√≥t</button>
</div>

<!-- ‚ïê‚ïê GLOBAL LEADERBOARD ‚ïê‚ïê -->
<div id="sLeaderboard" class="screen">
  <div class="topbar">
    <button class="back-btn" id="lbBackBtn">‚Üê Wr√≥ƒá</button>
    <span class="topbar-title">Global Leaderboard</span>
  </div>
  <div id="globalLb"></div>
</div>

<script type="module">
import { initializeApp }                        from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, GoogleAuthProvider,
         signInWithPopup, signOut,
         onAuthStateChanged }                   from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, doc,
         addDoc, updateDoc, deleteDoc,
         onSnapshot, serverTimestamp }          from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* ‚îÄ‚îÄ Firebase init ‚îÄ‚îÄ */
const firebaseConfig = {
  apiKey:            "AIzaSyCCKP7HLC-02Smn-I8TYCyZuGEz0Mybkg0",
  authDomain:        "padel-koty.firebaseapp.com",
  projectId:         "padel-koty",
  storageBucket:     "padel-koty.firebasestorage.app",
  messagingSenderId: "202084399128",
  appId:             "1:202084399128:web:9115ca5fd18c06e569eb6d"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let currentUser       = null;
let playersCache      = [];
let tournamentsCache  = [];
let activeTournamentId = null;
let activeTournament  = null;   // local working copy during a round
let selectedPlayers   = new Set();
let unsubPlayers      = null;
let unsubTournaments  = null;

const COURT_SCORE = 21;
const MONTHS_PL   = ['Stycze≈Ñ','Luty','Marzec','Kwiecie≈Ñ','Maj','Czerwiec',
                     'Lipiec','Sierpie≈Ñ','Wrzesie≈Ñ','Pa≈∫dziernik','Listopad','Grudzie≈Ñ'];

/* ‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê */
function navigate(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

/* ‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê */
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    document.getElementById('userPhoto').src = user.photoURL || '';
    document.getElementById('userName').textContent = user.displayName?.split(' ')[0] || user.email;
    startListeners();
    navigate('sHome');
  } else {
    stopListeners();
    navigate('sLogin');
  }
});

document.getElementById('googleSignInBtn').onclick = async () => {
  try {
    await signInWithPopup(auth, new GoogleAuthProvider());
  } catch(e) {
    document.getElementById('loginErr').textContent = 'B≈ÇƒÖd logowania: ' + e.message;
  }
};

document.getElementById('logoutBtn').onclick = () => signOut(auth);

/* ‚ïê‚ïê‚ïê FIRESTORE LISTENERS ‚ïê‚ïê‚ïê */
function startListeners() {
  unsubPlayers = onSnapshot(collection(db, 'players'), snap => {
    playersCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    playersCache.sort((a, b) => a.name.localeCompare(b.name));
    if (isActive('sPlayers'))     renderPlayersList();
    if (isActive('sCreate'))      renderCreatePlayerList();
  });

  unsubTournaments = onSnapshot(collection(db, 'tournaments'), snap => {
    tournamentsCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    tournamentsCache.sort((a, b) => (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0));
    if (isActive('sHome'))        renderHome();
    if (isActive('sLeaderboard')) renderGlobalLeaderboard();
  });
}

function stopListeners() {
  if (unsubPlayers)     unsubPlayers();
  if (unsubTournaments) unsubTournaments();
}

function isActive(id) {
  return document.getElementById(id).classList.contains('active');
}

/* ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê */
function initials(name) {
  return name.trim().split(/\s+/).map(w => w[0]).join('').toUpperCase().slice(0, 2);
}
function getPlayerName(id) {
  const p = playersCache.find(p => p.id === id);
  return p ? p.name : '?';
}
function monthLabel(val) {
  if (!val) return '';
  const [y, m] = val.split('-');
  return MONTHS_PL[parseInt(m) - 1] + ' ' + y;
}
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function buildMonthSelect() {
  const sel = document.getElementById('tMonth');
  sel.innerHTML = '';
  const now = new Date();
  for (let offset = -6; offset <= 12; offset++) {
    const d   = new Date(now.getFullYear(), now.getMonth() + offset, 1);
    const val = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = MONTHS_PL[d.getMonth()] + ' ' + d.getFullYear();
    if (offset === 0) opt.selected = true;
    sel.appendChild(opt);
  }
}

/* ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê */
function renderHome() {
  const box = document.getElementById('homeTournaments');
  if (!tournamentsCache.length) {
    box.innerHTML = '<div class="empty"><div class="empty-icon">üéæ</div>Brak turniej√≥w. Utw√≥rz pierwszy!</div>';
    return;
  }
  box.innerHTML = '';
  const byMonth = {};
  tournamentsCache.forEach(t => {
    if (!byMonth[t.month]) byMonth[t.month] = [];
    byMonth[t.month].push(t);
  });
  Object.keys(byMonth).sort().reverse().forEach(month => {
    const grp = document.createElement('div');
    grp.innerHTML = `<div class="month-badge">${monthLabel(month)}</div>`;
    byMonth[month].forEach(t => {
      const played   = (t.rounds || []).length;
      const finished = t.status === 'finished';
      const card     = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-row">
          <div>
            <div class="card-title">${t.name}</div>
            <div class="card-meta">${(t.playerIds||[]).length} graczy ¬∑ ${played}/${t.totalRounds} rund</div>
          </div>
          <span class="badge ${finished ? 'badge-muted' : 'badge-green'}">${finished ? 'Zako≈Ñczony' : 'Aktywny'}</span>
        </div>`;
      card.onclick = () => openTournament(t.id);
      grp.appendChild(card);
    });
    box.appendChild(grp);
  });
}

document.getElementById('newTournamentBtn').onclick   = goCreate;
document.getElementById('homePlayersBtn').onclick     = () => { renderPlayersList(); navigate('sPlayers'); };
document.getElementById('homeLeaderboardBtn').onclick = () => { renderGlobalLeaderboard(); navigate('sLeaderboard'); };

/* ‚ïê‚ïê‚ïê PLAYERS ‚ïê‚ïê‚ïê */
document.getElementById('playersBackBtn').onclick = () => navigate('sHome');
document.getElementById('addPlayerBtn').onclick   = addPlayer;
document.getElementById('newPlayerInp').onkeydown = e => { if (e.key === 'Enter') addPlayer(); };

async function addPlayer() {
  const inp  = document.getElementById('newPlayerInp');
  const name = inp.value.trim();
  if (!name) return;
  if (playersCache.find(p => p.name.toLowerCase() === name.toLowerCase())) {
    alert('Gracz o tym imieniu ju≈º istnieje!'); return;
  }
  inp.value = '';
  await addDoc(collection(db, 'players'), { name, createdAt: serverTimestamp() });
}

async function removePlayer(id) {
  if (!confirm('UsunƒÖƒá gracza z bazy?')) return;
  await deleteDoc(doc(db, 'players', id));
}

function renderPlayersList() {
  const box = document.getElementById('playersList');
  if (!playersCache.length) {
    box.innerHTML = '<div class="empty"><div class="empty-icon">üë§</div>Brak graczy. Dodaj pierwszego!</div>';
    return;
  }
  box.innerHTML = '';
  playersCache.forEach(p => {
    const el = document.createElement('div');
    el.className = 'player-item';
    el.innerHTML = `
      <div class="avatar">${initials(p.name)}</div>
      <div class="player-name">${p.name}</div>
      <button class="icon-btn" data-id="${p.id}">‚úï</button>`;
    el.querySelector('.icon-btn').onclick = () => removePlayer(p.id);
    box.appendChild(el);
  });
}

/* ‚ïê‚ïê‚ïê CREATE TOURNAMENT ‚ïê‚ïê‚ïê */
document.getElementById('createBackBtn').onclick      = () => navigate('sHome');
document.getElementById('startTournamentBtn').onclick = startTournament;

function goCreate() {
  buildMonthSelect();
  selectedPlayers = new Set();
  document.getElementById('tName').value = '';
  document.getElementById('createErr').innerHTML = '';
  renderCreatePlayerList();
  navigate('sCreate');
}

function renderCreatePlayerList() {
  const box = document.getElementById('createPlayerList');
  document.getElementById('selectedCount').textContent = selectedPlayers.size + ' wybranych';
  if (!playersCache.length) {
    box.innerHTML = '<div class="empty">Najpierw dodaj graczy w sekcji üë• Gracze</div>'; return;
  }
  box.innerHTML = '';
  playersCache.forEach(p => {
    const sel = selectedPlayers.has(p.id);
    const el  = document.createElement('div');
    el.className = 'player-check-item' + (sel ? ' selected' : '');
    el.id = 'cp_' + p.id;
    el.innerHTML = `
      <div class="avatar">${initials(p.name)}</div>
      <div class="player-name">${p.name}</div>
      <div class="check-icon">${sel ? '‚úÖ' : '‚¨ú'}</div>`;
    el.onclick = () => {
      if (selectedPlayers.has(p.id)) selectedPlayers.delete(p.id);
      else selectedPlayers.add(p.id);
      const s = selectedPlayers.has(p.id);
      el.classList.toggle('selected', s);
      el.querySelector('.check-icon').textContent = s ? '‚úÖ' : '‚¨ú';
      document.getElementById('selectedCount').textContent = selectedPlayers.size + ' wybranych';
    };
    box.appendChild(el);
  });
}

async function startTournament() {
  const name        = document.getElementById('tName').value.trim() || 'Turniej';
  const month       = document.getElementById('tMonth').value;
  const totalRounds = parseInt(document.getElementById('tRounds').value);
  const playerIds   = shuffle([...selectedPlayers]);
  const errBox      = document.getElementById('createErr');

  if (playerIds.length < 4) {
    errBox.innerHTML = '<div class="inline-err">‚ö† Wybierz co najmniej 4 graczy!</div>'; return;
  }
  errBox.innerHTML = '';

  const ref = await addDoc(collection(db, 'tournaments'), {
    name, month, totalRounds, playerIds,
    status: 'active', rounds: [],
    createdAt: serverTimestamp(),
    createdBy: currentUser.uid
  });
  openTournament(ref.id);
}

/* ‚ïê‚ïê‚ïê AMERICANO ‚ïê‚ïê‚ïê */
function makeMatchups(playerIds, pts) {
  const ranked    = [...playerIds].sort((a, b) => (pts[b]||0) - (pts[a]||0));
  const numCourts = Math.floor(ranked.length / 4);
  const resting   = ranked.slice(numCourts * 4);
  const courts    = [];
  for (let i = 0; i < numCourts; i++) {
    const g = ranked.slice(i * 4, i * 4 + 4);
    courts.push({ court: i + 1, team1: [g[0], g[3]], team2: [g[1], g[2]] });
  }
  return { courts, resting };
}

function computePts(rounds, playerIds) {
  const pts = Object.fromEntries(playerIds.map(id => [id, 0]));
  (rounds || []).forEach(r => r.matches.forEach(m => {
    m.team1.forEach(id => { pts[id] = (pts[id]||0) + m.score1; });
    m.team2.forEach(id => { pts[id] = (pts[id]||0) + m.score2; });
  }));
  return pts;
}

/* ‚ïê‚ïê‚ïê OPEN / LOAD ROUND ‚ïê‚ïê‚ïê */
function openTournament(id) {
  const t = tournamentsCache.find(t => t.id === id);
  if (!t) return;
  activeTournamentId = id;
  if (t.status === 'finished') { showResults(t); return; }
  loadRound(t);
}

function loadRound(t) {
  activeTournament = { ...t };
  const pts      = computePts(t.rounds, t.playerIds);
  const roundNum = (t.rounds || []).length + 1;
  activeTournament._matchups = makeMatchups(t.playerIds, pts);

  document.getElementById('playTitle').textContent      = t.name;
  document.getElementById('roundNum').textContent       = roundNum + ' / ' + t.totalRounds;
  document.getElementById('progressBar').style.width    = ((roundNum-1)/t.totalRounds*100) + '%';
  document.getElementById('nextRoundBtn').textContent   = roundNum >= t.totalRounds ? 'Podsumuj wyniki ‚Üí' : 'Nastƒôpna runda ‚Üí';
  document.getElementById('standingsWrap').style.display = 'none';

  renderCourts();
  navigate('sPlay');
}

/* ‚ïê‚ïê‚ïê RENDER COURTS ‚ïê‚ïê‚ïê */
function renderCourts() {
  const { courts, resting } = activeTournament._matchups;
  const rb  = document.getElementById('restingBar');
  rb.innerHTML = resting.length
    ? `<div class="resting-bar">‚è∏ OdpoczywajƒÖ: <strong>${resting.map(id=>getPlayerName(id)).join(', ')}</strong></div>`
    : '';

  document.getElementById('playErr').innerHTML = '';
  const box = document.getElementById('courtsArea');
  box.innerHTML = '';

  courts.forEach((c, idx) => {
    const n1 = c.team1.map(id => getPlayerName(id)).join(' & ');
    const n2 = c.team2.map(id => getPlayerName(id)).join(' & ');
    const card = document.createElement('div');
    card.className = 'court-card';
    card.innerHTML = `
      <span class="court-badge">Kort ${c.court}</span>
      <div class="teams-row">
        <div class="team-lbl">${n1}</div>
        <div class="vs-pill">VS</div>
        <div class="team-lbl right">${n2}</div>
      </div>
      <div class="score-row">
        <div class="score-box">
          <div class="score-cap">${n1}</div>
          <input class="score-inp" id="s${idx}" type="number" inputmode="numeric"
                 min="0" max="21" placeholder="‚Äî">
        </div>
        <div class="score-sep">:</div>
        <div class="score-box">
          <div class="score-cap">${n2}</div>
          <input class="score-inp" id="o${idx}" type="number" placeholder="‚Äî" disabled>
        </div>
      </div>`;
    box.appendChild(card);

    document.getElementById('s' + idx).oninput = () => {
      const inp = document.getElementById('s' + idx);
      const opp = document.getElementById('o' + idx);
      if (inp.value === '') { opp.value = ''; return; }
      let v = Math.max(0, Math.min(COURT_SCORE, parseInt(inp.value, 10)));
      if (isNaN(v)) { inp.value = ''; opp.value = ''; return; }
      inp.value = v; opp.value = COURT_SCORE - v;
    };
    document.getElementById('s' + idx).onfocus = function() { this.select(); };
  });

  setTimeout(() => { const f = document.getElementById('s0'); if(f) f.focus(); }, 60);
}

/* ‚ïê‚ïê‚ïê ADVANCE ROUND ‚ïê‚ïê‚ïê */
document.getElementById('nextRoundBtn').onclick = advanceRound;

async function advanceRound() {
  const { courts } = activeTournament._matchups;
  document.getElementById('playErr').innerHTML = '';

  for (let i = 0; i < courts.length; i++) {
    if (document.getElementById('s'+i).value === '') {
      document.getElementById('playErr').innerHTML =
        `<div class="inline-err">‚ö† Wpisz wynik dla Kortu ${courts[i].court}</div>`;
      return;
    }
  }

  const matches = courts.map((c, i) => {
    const s1 = parseInt(document.getElementById('s'+i).value, 10);
    return { court: c.court, team1: c.team1, team2: c.team2, score1: s1, score2: COURT_SCORE-s1 };
  });

  const newRounds = [...(activeTournament.rounds||[]), { roundNum:(activeTournament.rounds||[]).length+1, matches }];
  const newStatus = newRounds.length >= activeTournament.totalRounds ? 'finished' : 'active';

  document.getElementById('nextRoundBtn').disabled = true;
  await updateDoc(doc(db, 'tournaments', activeTournamentId), { rounds: newRounds, status: newStatus });
  document.getElementById('nextRoundBtn').disabled = false;

  const updated = { ...activeTournament, rounds: newRounds, status: newStatus };
  if (newStatus === 'finished') { showResults(updated); }
  else { loadRound(updated); window.scrollTo({ top:0, behavior:'smooth' }); }
}

/* ‚ïê‚ïê‚ïê FINISH EARLY ‚ïê‚ïê‚ïê */
document.getElementById('finishEarlyBtn').onclick = async () => {
  if (!confirm('Zako≈Ñczyƒá turniej i pokazaƒá wyniki?')) return;
  await updateDoc(doc(db, 'tournaments', activeTournamentId), { status: 'finished' });
  showResults({ ...activeTournament, status: 'finished' });
};

/* ‚ïê‚ïê‚ïê STANDINGS TOGGLE ‚ïê‚ïê‚ïê */
document.getElementById('standingsBtn').onclick = () => {
  const wrap = document.getElementById('standingsWrap');
  if (wrap.style.display !== 'none') { wrap.style.display = 'none'; return; }
  const t = activeTournament;
  if (!(t.rounds||[]).length) {
    wrap.innerHTML = '<div class="empty" style="padding:20px">Zagraj przynajmniej jednƒÖ rundƒô!</div>';
    wrap.style.display = 'block'; return;
  }
  const stats   = calcStats([t], t.playerIds);
  const players = t.playerIds.map(id => ({ id, name: getPlayerName(id) }));
  players.sort((a,b) => (stats[b.id]?.pm||0) - (stats[a.id]?.pm||0));
  wrap.innerHTML = '';
  wrap.appendChild(makeLbElement('Aktualna tabela', players, stats));
  wrap.style.display = 'block';
};

/* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */
function calcStats(tournaments, filterIds) {
  const stats = {};
  tournaments.forEach(t => {
    (t.rounds||[]).forEach(r => r.matches.forEach(m => {
      const win1 = m.score1 > m.score2;
      m.team1.forEach(id => {
        if (filterIds && !filterIds.includes(id)) return;
        if (!stats[id]) stats[id] = { w:0, l:0, pf:0, pa:0, pm:0 };
        stats[id].pf += m.score1; stats[id].pa += m.score2;
        if (win1) stats[id].w++; else stats[id].l++;
      });
      m.team2.forEach(id => {
        if (filterIds && !filterIds.includes(id)) return;
        if (!stats[id]) stats[id] = { w:0, l:0, pf:0, pa:0, pm:0 };
        stats[id].pf += m.score2; stats[id].pa += m.score1;
        if (!win1) stats[id].w++; else stats[id].l++;
      });
    }));
  });
  Object.values(stats).forEach(s => { s.pm = s.pf - s.pa; });
  return stats;
}

/* ‚ïê‚ïê‚ïê RESULTS ‚ïê‚ïê‚ïê */
document.getElementById('resultsBackBtn').onclick = () => navigate('sHome');
document.getElementById('resultsHomeBtn').onclick  = () => navigate('sHome');

function showResults(t) {
  document.getElementById('resultsTitle').textContent = t.name;
  document.getElementById('resultsSub').textContent   = monthLabel(t.month) + ' ¬∑ ' + (t.rounds||[]).length + ' rund';
  const stats   = calcStats([t], t.playerIds);
  const players = t.playerIds.map(id => ({ id, name: getPlayerName(id) }));
  players.sort((a,b) => (stats[b.id]?.pm||0) - (stats[a.id]?.pm||0));
  const box = document.getElementById('resultsLb');
  box.innerHTML = '';
  box.appendChild(makeLbElement('Wyniki ko≈Ñcowe', players, stats));
  navigate('sResults');
}

/* ‚ïê‚ïê‚ïê GLOBAL LEADERBOARD ‚ïê‚ïê‚ïê */
document.getElementById('lbBackBtn').onclick = () => navigate('sHome');

function renderGlobalLeaderboard() {
  const box = document.getElementById('globalLb');
  box.innerHTML = '';
  if (!tournamentsCache.length) {
    box.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div>Brak danych. Rozegraj pierwszy turniej!</div>';
    return;
  }
  const stats   = calcStats(tournamentsCache);
  const players = playersCache.filter(p => stats[p.id]);
  if (!players.length) {
    box.innerHTML = '<div class="empty"><div class="empty-icon">üèÜ</div>Brak rozegranych mecz√≥w.</div>';
    return;
  }
  players.sort((a,b) => (stats[b.id]?.pm||0) - (stats[a.id]?.pm||0));
  box.appendChild(makeLbElement('Wszystkie turnieje ¬∑ ' + tournamentsCache.length + ' sesji', players, stats));

  const byMonth = {};
  tournamentsCache.forEach(t => {
    if (!(t.rounds||[]).length) return;
    if (!byMonth[t.month]) byMonth[t.month] = [];
    byMonth[t.month].push(t);
  });
  Object.keys(byMonth).sort().reverse().forEach(month => {
    const mTours   = byMonth[month];
    const mStats   = calcStats(mTours);
    const mPlayers = playersCache.filter(p => mStats[p.id]);
    if (!mPlayers.length) return;
    mPlayers.sort((a,b) => (mStats[b.id]?.pm||0) - (mStats[a.id]?.pm||0));
    box.appendChild(makeLbElement(monthLabel(month), mPlayers, mStats));
  });
}

/* ‚ïê‚ïê‚ïê LB BUILDER ‚ïê‚ïê‚ïê */
function makeLbElement(title, players, stats) {
  const medals = ['ü•á','ü•à','ü•â'];
  const cls    = ['r1','r2','r3'];
  const lb     = document.createElement('div');
  lb.className = 'lb';
  lb.innerHTML = `
    <div class="lb-title">${title}</div>
    <div class="lb-head">
      <span>#</span><span style="text-align:left">Gracz</span>
      <span>W</span><span>L</span><span>PF</span><span>PA</span><span>+/-</span>
    </div>`;
  players.forEach((p, i) => {
    const s      = stats[p.id] || { w:0, l:0, pf:0, pa:0, pm:0 };
    const pmStr  = s.pm > 0 ? '+'+s.pm : String(s.pm);
    const pmCls  = s.pm > 0 ? 'pos' : s.pm < 0 ? 'neg' : 'zer';
    const row    = document.createElement('div');
    row.className = 'lb-row' + (i < 3 ? ' '+cls[i] : '');
    row.innerHTML = `
      <div class="lb-rank">${medals[i] ?? (i+1)}</div>
      <div class="lb-name">${p.name}</div>
      <div class="lb-cell">${s.w}</div>
      <div class="lb-cell">${s.l}</div>
      <div class="lb-cell">${s.pf}</div>
      <div class="lb-cell">${s.pa}</div>
      <div class="lb-pm ${pmCls}">${pmStr}</div>`;
    lb.appendChild(row);
  });
  return lb;
}

/* ‚ïê‚ïê‚ïê BACK BUTTONS ‚ïê‚ïê‚ïê */
document.getElementById('playBackBtn').onclick = () => navigate('sHome');
</script>
</body>
</html>
